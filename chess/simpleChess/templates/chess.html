{% load staticfiles %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Sjakk</title>

  <link rel="stylesheet" href="{% static "css/chessboard.css" %}" />
  <link rel="stylesheet" href="{% static "css/bootstrap.min.css" %}" />
</head>
<body>



<div class="container">

  <div class="row">

    <div class ="col-md-8">

      <div id="board" style="width: 500px"></div>

    </div>
    <div class="col-md-4">

      <div class="row">
          <br/>
        <form method="post">{% csrf_token %}
        {{ f.as_p }}
        <input class="btn btn-primary" type="submit" value="Send Trekk" />
        </form>
      </div>
      <div class="row">
        <br />
        <Button class="btn btn-primary" onClick="resetGame()" >Nytt Spill</button>
        <br />
      </div>

      <div class="row">
        <br />
        <Button class="btn btn-primary" onClick="restoreInitialFen()">Tilbakestill</button>
        <br />
      </div>
      <div class="row">
        <br />
        <Button class="btn btn-primary" onClick="rotateBoard()">Snu Brettet</button>
        <br />
      </div>
    </div>

  </div>

</div>


<script src="{% static "js/json3.min.js" %}"></script>
<script src="{% static "js/jquery-1.10.1.min.js" %}"></script>
<script src="{% static "js/chess.min.js" %}"></script>
<script src="{% static "js/chessboard.js" %}"></script>


<script>
var board;
var initialFen = "{{ gameData.fen }}";
var game = new Chess();

var onSnapEnd = function(){
  updateFen();
};

// Init
// ----------
var init = function() {

var cfg = {
	draggable : true,
  pieceTheme: '{% static "img/chesspieces/wikipedia/" %}{piece}.png',
	position : "{{ gameData.fen }}",
  onSnapEnd: onSnapEnd,
  sparePieces: true,
}
board = new ChessBoard('board', cfg);

$("#id_fen").val("{{ gameData.fen }}");

readCookie();
}; 
// ---------
// end init()

var rotateBoard = function()
{
  board.flip();
  writeCookie();
};

var updateFen = function()
{
  $("#id_fen").val(board.fen());
};

var restoreInitialFen = function()
{
  board.position(initialFen);
};

setInterval(function() {
  $.ajax({
    url: 'http://python.torsjakk.com/getGameFen/',
    type: 'get',
    success: function(data) {
        if(data === initialFen)
        {
            var doNothing = 0;
        }
        else
        {
            initialFen = data
            board.position(data)
            updateFen()
        }
    },
    failure: function(data) {
        alert('Problemer med Ã¥ laste brettet, er du tilkoblet internett?');
    }
});
}, 5000)

var resetGame = function()
{
  board.position("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR")
  $("#id_fen").val(board.fen());
};

var writeCookie = function()
{
  document.cookie = "name="+board.orientation();
};

var readCookie = function()
{
  var color = getCookie(name);
  if (color === "white")
    board.orientation("white");
  else
    board.orientation("black");
};

function getCookie(cname)
{
var name = cname + "=";
var ca = document.cookie.split(';');
for(var i=0; i<ca.length; i++) 
  {
  var c = ca[i].trim();
  if (c.indexOf(name)==0) return c.substring(name.length,c.length);
  }
return "";
}

$(document).ready(init);
</script>
</body>
</html>